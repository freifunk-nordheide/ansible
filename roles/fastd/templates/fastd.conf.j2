# {{ ansible_managed }}

user "fastd";
group "fastd";

log to syslog level warn;
# hide ip addresses yes;
status socket "/run/fastd/vpn-{{ site_code }}{{ item }}.sock";

interface "vpn-{{ site_code }}{{ item }}";

method "null";
method "salsa2012+umac";

# secure handshakes yes;
mode tap;

bind {{ fastd_bind }}: {{ (fastd_port|int + item|int)|string }} interface "{{ base_if }}";

include "secret.conf";

mtu {{ mtu }};

{% if fastd_peers_limit > -1 %}
	{% if item|int == 0 %}
peer limit {{ (fastd_peers_limit-10)|string }};
	{% elif item|int == (fastd_instances-1) %}
peer limit {{ (fastd_peers_limit+10)|string }};
	{% else %}
peer limit {{ fastd_peers_limit|string }};
	{% endif %}
{% endif %}

on up "
	ip link set dev $INTERFACE address {{ hw_address_prefix }}{ unit_id }}:{{ (10 + item|int)|string }}
	ip link set dev $INTERFACE up
	ifup {{ batman_interface }}
	sh /etc/fastd/iptables_{{ site }}.sh
";

on down "
	ifdown {{ batman_interface }}

";

on verify "true";

# {% if fastd_anonymous %}
# on verify "true";
# {% endif %}

include peers from "peers";

